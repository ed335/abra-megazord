generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Usuario {
  id              String         @id @default(cuid())
  email           String         @unique
  password        String
  role            Role           @default(PACIENTE)
  ativo           Boolean        @default(true)
  emailVerificado Boolean        @default(false)
  criadoEm        DateTime       @default(now())
  atualizadoEm    DateTime       @updatedAt
  deletadoEm      DateTime?
  admin           Admin?
  logsAuditoria   LogAuditoria[]
  paciente        Paciente?
  prescritor      Prescritor?
  sessions        Session[]

  @@index([email])
  @@index([role])
}

model Session {
  id           String   @id @default(cuid())
  usuarioId    String
  refreshToken String?
  ipAddress    String?
  userAgent    String?
  criadoEm     DateTime @default(now())
  expiresEm    DateTime
  usuario      Usuario  @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

  @@index([usuarioId])
  @@index([expiresEm])
}

model Paciente {
  id                     String              @id @default(cuid())
  usuarioId              String              @unique
  cpf                    String?             @unique
  nome                   String
  email                  String              @unique
  telefone               String?
  dataNascimento         DateTime?
  consenteLGPD           Boolean             @default(false)
  consentimentoEm        DateTime?
  dataDelecaoAgendada    DateTime?
  rua                    String?
  numero                 String?
  complemento            String?
  cidade                 String?
  estado                 String?
  cep                    String?
  condicoes              String[]            @default([])
  alergias               String[]            @default([])
  medicamentos           String[]            @default([])
  criadoEm               DateTime            @default(now())
  atualizadoEm           DateTime            @updatedAt
  bairro                 String?
  documentoIdentidadeUrl String?
  documentosMedicosUrls  String[]            @default([])
  jaUsaCannabis          Boolean             @default(false)
  patologiaCID           String?
  termoAjuizamento       Boolean             @default(false)
  termoAjuizamentoEm     DateTime?
  whatsapp               String
  consentimentos         ConsentimentoLGPD[]
  usuario                Usuario             @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  preAnamnese            PreAnamnese?
  prescricoes            Prescricao[]

  @@index([usuarioId])
  @@index([cpf])
  @@index([whatsapp])
}

model Prescritor {
  id              String       @id @default(cuid())
  usuarioId       String       @unique
  crm             String       @unique
  nome            String
  especialidade   String
  instituicao     String?
  email           String       @unique
  telefone        String?
  crmVerificado   Boolean      @default(false)
  dataVerificacao DateTime?
  criadoEm        DateTime     @default(now())
  atualizadoEm    DateTime     @updatedAt
  prescricoes     Prescricao[]
  usuario         Usuario      @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

  @@index([usuarioId])
  @@index([crm])
}

model Admin {
  id           String   @id @default(cuid())
  usuarioId    String   @unique
  permissoes   String[] @default([])
  notas        String?
  criadoEm     DateTime @default(now())
  atualizadoEm DateTime @updatedAt
  usuario      Usuario  @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
}

model Prescricao {
  id             String           @id @default(cuid())
  pacienteId     String
  prescritorId   String
  descricao      String
  dosagem        String
  frequencia     String
  duracao        String
  certificadoUrl String?
  qrCode         String?
  status         StatusPrescricao @default(ATIVA)
  validadeDe     DateTime
  validadeAte    DateTime
  assinatura     String?
  criadoEm       DateTime         @default(now())
  atualizadoEm   DateTime         @updatedAt
  paciente       Paciente         @relation(fields: [pacienteId], references: [id], onDelete: Cascade)
  prescritor     Prescritor       @relation(fields: [prescritorId], references: [id])

  @@index([pacienteId])
  @@index([prescritorId])
  @@index([status])
  @@index([validadeAte])
}

model Artigo {
  id            String          @id @default(cuid())
  titulo        String
  slug          String          @unique
  conteudo      String
  resumo        String?
  autor         String
  categoria     CategoriaArtigo
  tags          String[]        @default([])
  publicado     Boolean         @default(false)
  visualizacoes Int             @default(0)
  imagemUrl     String?
  criadoEm      DateTime        @default(now())
  atualizadoEm  DateTime        @updatedAt
  publicadoEm   DateTime?

  @@index([slug])
  @@index([categoria])
  @@index([publicado])
}

model LogAuditoria {
  id        String   @id @default(cuid())
  usuarioId String?
  acao      String
  recurso   String
  recursoId String?
  detalhes  Json?
  ipAddress String?
  userAgent String?
  criadoEm  DateTime @default(now())
  usuario   Usuario? @relation(fields: [usuarioId], references: [id])

  @@index([usuarioId])
  @@index([acao])
  @@index([recurso])
  @@index([criadoEm])
}

model Intake {
  id                        String       @id @default(cuid())
  perfil                    PerfilIntake
  condicaoPrincipal         String?
  objetivoPrincipal         String?
  gravidade                 Int?
  tratamentosPrevios        String[]     @default([])
  comorbidades              String[]     @default([])
  notas                     String?
  preferenciaAcompanhamento String?
  melhorHorario             String?
  contatoEmail              String
  contatoWhatsapp           String?
  cidade                    String?
  estado                    String?
  consentiu                 Boolean      @default(false)
  origem                    String?
  criadoEm                  DateTime     @default(now())
  atualizadoEm              DateTime     @updatedAt

  @@index([perfil])
  @@index([contatoEmail])
  @@index([cidade, estado])
}

model PreAnamnese {
  id                        String       @id @default(cuid())
  pacienteId                String       @unique
  perfil                    PerfilIntake
  objetivoPrincipal         String?
  gravidade                 Int?
  tratamentosPrevios        String[]     @default([])
  comorbidades              String[]     @default([])
  notas                     String?
  preferenciaAcompanhamento String?
  melhorHorario             String?
  diagnostico               Json?
  scorePrioridade           Int?
  recomendacoes             String[]     @default([])
  proximosPasso             String?
  criadoEm                  DateTime     @default(now())
  atualizadoEm              DateTime     @updatedAt
  paciente                  Paciente     @relation(fields: [pacienteId], references: [id], onDelete: Cascade)

  @@index([pacienteId])
  @@index([scorePrioridade])
}

model ConsentimentoLGPD {
  id          String   @id @default(cuid())
  pacienteId  String
  versaoTermo String
  hashTermo   String
  aceito      Boolean  @default(false)
  ipAddress   String?
  userAgent   String?
  criadoEm    DateTime @default(now())
  paciente    Paciente @relation(fields: [pacienteId], references: [id], onDelete: Cascade)

  @@index([pacienteId])
}

enum Role {
  PACIENTE
  PRESCRITOR
  ADMIN
}

enum StatusPrescricao {
  ATIVA
  VENCIDA
  CANCELADA
  UTILIZADA
}

enum CategoriaArtigo {
  EDUCACAO
  PESQUISA
  ORIENTACAO
  LEGISLACAO
}

enum PerfilIntake {
  PACIENTE_NOVO
  EM_TRATAMENTO
  CUIDADOR
}
